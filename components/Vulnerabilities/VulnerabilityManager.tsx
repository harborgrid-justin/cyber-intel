
import React from 'react';
import { Card, Button, Grid, Badge, CardHeader } from '../Shared/UI';
import { StandardPage } from '../Shared/Layouts';
import VulnOverview from './VulnOverview';
import VulnTable from './VulnTable';
import { Icons } from '../Shared/Icons';
import { useVulnerabilityIntel } from '../../hooks/modules/useVulnerabilityIntel';

const VulnerabilityManager: React.FC = () => {
  const {
    modules, activeModule, setActiveModule,
    activeScan, handleRunScan,
    vulns, patchStatus, scanners, 
    zeroDayImpact, correlatedFeeds,
    criticalCves, zeroDays, exploitedCves, scannerHealth,
    handlePatch
  } = useVulnerabilityIntel();

  return (
    <StandardPage 
      title="Vulnerability Intelligence" 
      subtitle="CVE Tracking & Patch Management"
      actions={
          activeScan ? (
              <div className="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded border border-cyan-900">
                  <span className="text-xs text-cyan-400 font-bold animate-pulse">SCANNING... {activeScan.progress}%</span>
              </div>
          ) : (
              <Button onClick={handleRunScan} variant="primary">RUN VULN SCAN</Button>
          )
      } 
      modules={modules} 
      activeModule={activeModule} 
      onModuleChange={setActiveModule}
    >
      {activeModule === 'Overview' && <VulnOverview vulns={vulns} patchStatus={patchStatus} criticalCves={criticalCves} zeroDays={zeroDays} handlePatch={handlePatch} />}
      
      {activeModule === 'Critical Watch' && (
          <Card className="p-0 overflow-hidden border-l-4 border-l-red-600 flex flex-col h-full">
            <CardHeader title="High Priority Assets" className="bg-red-900/10 border-b border-red-900/30 text-red-500" />
            <div className="flex-1 overflow-y-auto">
                <VulnTable data={criticalCves} onPatch={handlePatch} showSla={true} />
            </div>
          </Card>
      )}
      
      {activeModule === 'Zero-Days' && (
          <div className="space-y-6">
             <div className="grid grid-cols-2 gap-6">
                <Card className="p-4 flex items-center justify-between bg-orange-900/10 border-orange-500">
                    <div>
                        <div className="text-2xl font-bold text-orange-500">{zeroDays.length}</div>
                        <div className="text-xs font-bold text-orange-400 uppercase">Active Zero Days</div>
                    </div>
                    <Icons.AlertTriangle className="w-8 h-8 text-orange-500" />
                </Card>
                <Card className="p-4 flex items-center justify-between">
                    <div>
                        <div className="text-2xl font-bold text-white">{zeroDayImpact.affectedAssets}</div>
                        <div className="text-xs font-bold text-slate-500 uppercase">Impacted Assets</div>
                    </div>
                    <Icons.Server className="w-8 h-8 text-slate-600" />
                </Card>
             </div>
             <Card className="p-0 overflow-hidden border-l-4 border-l-orange-500">
                <CardHeader title="Zero-Day Threats" className="bg-orange-900/10 border-b border-orange-900/30 text-orange-500" />
                <VulnTable data={zeroDays} onPatch={handlePatch} />
             </Card>
          </div>
      )}
      
      {activeModule === 'Exploited' && (
          <Card className="p-0 overflow-hidden flex flex-col h-full">
            <CardHeader title="Known Exploited Vulnerabilities (KEV)" action={<Badge color="red">CISA KEV MATCH</Badge>} />
            <VulnTable data={exploitedCves} onPatch={handlePatch} />
          </Card>
      )}
      
      {activeModule === 'Patch Status' && (
        <Grid cols={2}>
          {patchStatus.map((sys, i) => (
            <Card key={i} className="p-6">
               <div className="flex justify-between items-end mb-2"><span className="font-bold text-white">{sys.system}</span><span className={`text-xl font-bold ${sys.compliance > 95 ? 'text-green-500' : sys.compliance > 80 ? 'text-yellow-500' : 'text-red-500'}`}>{sys.compliance}%</span></div>
               <div className="w-full bg-slate-800 h-2 rounded-full overflow-hidden mb-2"><div className={`h-full ${sys.compliance > 95 ? 'bg-green-500' : sys.compliance > 80 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${sys.compliance}%` }}></div></div>
               <div className="flex justify-between text-xs text-slate-500">
                   <span>{sys.patched} / {sys.total} Assets Patched</span>
                   {sys.compliance < 90 && <span className="text-red-400 font-bold">{sys.total - sys.patched} PENDING</span>}
               </div>
            </Card>
          ))}
        </Grid>
      )}

      {activeModule === 'Scanners' && (
        <div className="space-y-6">
            {scannerHealth.healthScore < 100 && (
                <div className="bg-red-900/10 border border-red-900/50 p-4 rounded text-red-300 text-sm flex gap-2 items-start">
                    <Icons.AlertTriangle className="w-5 h-5 shrink-0" />
                    <div>
                        <div className="font-bold mb-1">Scanner Health Issues Detected ({scannerHealth.healthScore}%)</div>
                        <ul className="list-disc pl-4 text-xs space-y-1">
                            {scannerHealth.issues.map((iss, i) => <li key={i}>{iss}</li>)}
                        </ul>
                    </div>
                </div>
            )}
            <Grid cols={3}>{scanners.map((s, i) => (
                <Card key={i} className="p-6 flex flex-col gap-4 relative overflow-hidden">
                    <div className={`absolute top-0 right-0 p-2 text-[10px] font-bold ${s.status === 'ONLINE' ? 'bg-green-900 text-green-400' : 'bg-yellow-900 text-yellow-400'}`}>{s.status}</div>
                    <div><h3 className="text-lg font-bold text-white">{s.name}</h3><div className="text-xs text-slate-500">Last Scan: {s.lastScan}</div></div>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                    <div className="bg-slate-900 p-2 rounded"><div className="text-[10px] text-slate-500 uppercase">Coverage</div><div className="font-bold text-cyan-500">{s.coverage}</div></div>
                    <div className="bg-slate-900 p-2 rounded"><div className="text-[10px] text-slate-500 uppercase">Findings</div><div className="font-bold text-red-500">{s.findings}</div></div>
                    </div>
                </Card>
            ))}</Grid>
        </div>
      )}

      {activeModule === 'Vendor Feeds' && (
        <div className="space-y-4">
            {correlatedFeeds.map((f, i) => (
             <Card key={i} className={`p-4 transition-colors ${f.matchedAssets ? 'border-l-4 border-l-red-500 bg-red-900/5' : 'hover:border-cyan-500'}`}>
                <div className="flex justify-between">
                    <span className="text-xs font-bold text-cyan-400 uppercase">{f.vendor}</span>
                    <span className="text-xs text-slate-500">{f.date}</span>
                </div>
                <h4 className="text-white font-bold my-1">{f.title}</h4>
                <div className="flex justify-between items-center mt-2">
                    <div className="flex gap-2">
                        <Badge color={f.severity === 'Critical' ? 'red' : f.severity === 'High' ? 'orange' : 'blue'}>{f.severity}</Badge>
                        {f.cveIds?.map((cve: string) => <Badge key={cve} color="slate">{cve}</Badge>)}
                    </div>
                    {f.matchedAssets ? (
                        <div className="text-xs font-bold text-red-400 flex items-center gap-1">
                            <Icons.Server className="w-3 h-3" /> {f.matchedAssets} Assets Affected
                        </div>
                    ) : <span className="text-xs text-slate-600">No local impact detected</span>}
                </div>
             </Card>
        ))}</div>
      )}
    </StandardPage>
  );
};
export default VulnerabilityManager;
