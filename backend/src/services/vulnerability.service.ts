
import { Vulnerability } from '../models/infrastructure';
import { AuditService } from './audit.service';

interface CreateVulnInput {
  cveId: string;
  name: string;
  score: number;
  status: string;
  vendor?: string;
  zeroDay?: boolean;
  exploited?: boolean;
  affectedAssets?: string[];
}

export class VulnerabilityService {
  static async getAll(): Promise<Vulnerability[]> {
    return await (Vulnerability as any).findAll({ order: [['score', 'DESC']] });
  }

  static async create(data: CreateVulnInput, userId: string): Promise<Vulnerability> {
    const vuln = await (Vulnerability as any).create({
      id: data.cveId,
      name: data.name,
      score: data.score,
      status: data.status,
      vendor: data.vendor || 'Unknown',
      zero_day: data.zeroDay || false,
      exploited: data.exploited || false,
      affected_assets: data.affectedAssets || []
    });
    
    await AuditService.log(userId, 'VULN_TRACKED', `Started tracking ${data.cveId}`);
    return vuln;
  }

  static async updateStatus(id: string, status: string, userId: string): Promise<Vulnerability | null> {
    const vuln = await (Vulnerability as any).findByPk(id);
    if (vuln) {
      vuln.status = status;
      await vuln.save();
      await AuditService.log(userId, 'VULN_UPDATE', `Updated ${id} status to ${status}`);
      return vuln;
    }
    return null;
  }
}
