import { Vulnerability, Asset, Feed } from '../../models/infrastructure';
import { Op } from 'sequelize';

export class VulnerabilityEngine {

  static async assessZeroDayImpact(): Promise<{ affectedAssets: number, mitigationRate: number }> {
    const zeroDays = await (Vulnerability as any).findAll({ where: { zero_day: true, status: { [Op.ne]: 'PATCHED' } } });
    const assets = await (Asset as any).findAll();
    
    if (zeroDays.length === 0) return { affectedAssets: 0, mitigationRate: 100 };

    const impactedIds = new Set<string>();
    zeroDays.forEach((z: any) => {
        const affected = z.affected_assets || [];
        affected.forEach((id: string) => impactedIds.add(id));
    });

    let mitigatedCount = 0;
    impactedIds.forEach(id => {
        const asset = assets.find((a: any) => a.id === id);
        // Mock mitigation logic based on asset type or status
        if (asset && asset.status === 'ONLINE') {
            mitigatedCount++; 
        }
    });

    return {
        affectedAssets: impactedIds.size,
        mitigationRate: impactedIds.size ? Math.round((mitigatedCount / impactedIds.size) * 100) : 100
    };
  }

  static async correlateVendorAdvisories() {
    // In a real system, this joins Feeds and Assets based on vendor string matching
    // For now, we mock the heavy lifting return structure
    const assets = await (Asset as any).findAll();
    // Assuming Feed model logic handles filtering
    const feeds = await (Feed as any).findAll({ where: { type: 'VENDOR_ADVISORY' } });
    
    // Simulating correlation results based on mock feed data if DB empty, 
    // but here we just return a structure derived from assets for the demo.
    return [
      { id: 'feed-item-1', vendor: 'Microsoft', title: 'Critical Azure Vulnerability', date: new Date(), severity: 'Critical', matchedAssets: assets.filter((a: any) => a.type === 'Server').length },
      { id: 'feed-item-2', vendor: 'Cisco', title: 'IOS XE Implant', date: new Date(), severity: 'High', matchedAssets: assets.filter((a: any) => a.type === 'Sensor').length }
    ];
  }
}